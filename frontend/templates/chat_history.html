<!--chat_history.html-->
{% extends "base.html" %}

{% block title %}Chat History - Legal Document Simplifier{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-history"></i>
            Chat History
        </h1>
        <p class="page-subtitle">View and continue your previous conversations</p>
    </div>

    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; height: 80vh;">
        <!-- Chat List Sidebar -->
        <div class="card" style="overflow: hidden;">
            <div class="card-header">
                <h3 style="margin: 0;">Conversations</h3>
                <button class="btn btn-sm btn-primary" onclick="startNewChat()">
                    <i class="fas fa-plus"></i> New Chat
                </button>
            </div>
            <div class="card-body" style="padding: 0; overflow-y: auto;">
                <div id="conversations-list">
                    <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Loading conversations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="card" style="display: flex; flex-direction: column;">
            <div class="card-header" id="chat-header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <h3 style="margin: 0;" id="chat-title">Select a conversation</h3>
                    <div id="chat-document-info" class="hidden">
                        <span class="status-badge" id="chat-document-name"></span>
                    </div>
                </div>
                <div id="chat-actions" class="hidden">
                    <button class="btn btn-sm btn-danger" onclick="deleteCurrentChat()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
            
            <div class="card-body" style="flex: 1; display: flex; flex-direction: column; padding: 0;">
                <!-- Messages Area -->
                <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem;">
                    <div id="welcome-message" style="text-align: center; color: var(--text-secondary); padding: 3rem;">
                        <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>Welcome to Legal AI Chat</h3>
                        <p>Select a conversation from the sidebar or start a new chat</p>
                    </div>
                </div>

                <!-- Input Area -->
                <div id="chat-input-area" class="hidden" style="border-top: 1px solid var(--border-color); padding: 1rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="chat-input" placeholder="Ask about your documents..." 
                               style="flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius);"
                               onkeypress="handleChatKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendMessage()" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="document-selector" style="margin-top: 0.5rem;">
                        <select id="document-select" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius);">
                            <option value="">Ask about all documents</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.conversation-item {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

.conversation-item:hover {
    background-color: var(--bg-secondary);
}

.conversation-item.active {
    background-color: var(--primary-color);
    color: white;
}

.message {
    margin-bottom: 1.5rem;
    display: flex;
    gap: 1rem;
}

.message.user {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.message.user .message-avatar {
    background-color: var(--primary-color);
    color: white;
}

.message.assistant .message-avatar {
    background-color: var(--accent-color);
    color: white;
}

.message-content {
    flex: 1;
    padding: 1rem;
    border-radius: var(--radius);
    line-height: 1.5;
}

.message.user .message-content {
    background-color: var(--primary-color);
    color: white;
    margin-left: 2rem;
}

.message.assistant .message-content {
    background-color: var(--bg-secondary);
    margin-right: 2rem;
}

.message-time {
    font-size: 0.8rem;
    opacity: 0.7;
    margin-top: 0.5rem;
}
</style>

<script>
let conversations = [];
let userDocuments = [];


document.addEventListener('DOMContentLoaded', function() {
    // Wait for main.js to be fully loaded
    function initializeChatHistory() {
        if (typeof window.apiCall === 'function') {
            loadChatHistory();
            loadUserDocuments();
        } else {
            console.log('Waiting for main.js to load...');
            setTimeout(initializeChatHistory, 100);
        }
    }
    
    initializeChatHistory();
});





async function loadChatHistory() {
    try {
        const response = await window.apiCall('/agents/conversations');
        conversations = response.conversations || [];
        renderConversationList();
    } catch (error) {
        console.error('Failed to load chat history:', error);
        window.showToast('Failed to load chat history', 'error');
    }
}

async function loadUserDocuments() {
    try {
        const response = await window.apiCall('/documents/');
        userDocuments = response.documents || [];
        updateDocumentSelector();
    } catch (error) {
        console.error('Failed to load documents:', error);
    }
}

function renderConversationList() {
    const container = document.getElementById('conversations-list');
    
    if (conversations.length === 0) {
        container.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <p>No conversations yet</p>
                <button class="btn btn-primary btn-sm" onclick="startNewChat()">Start Chatting</button>
            </div>
        `;
        return;
    }

    container.innerHTML = conversations.map(conv => `
        <div class="conversation-item" onclick="openConversation('${conv.id}')" data-id="${conv.id}">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">
                ${getConversationTitle(conv)}
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                ${conv.document_name || 'General Chat'}
            </div>
            <div style="font-size: 0.8rem; opacity: 0.7;">
                ${window.formatDate(conv.updated_at)} â€¢ ${conv.message_count} messages
            </div>
        </div>
    `).join('');
}

function getConversationTitle(conv) {
    if (conv.messages && conv.messages.length > 0) {
        const firstMessage = conv.messages.find(m => m.role === 'user');
        return firstMessage ? firstMessage.content.substring(0, 50) + '...' : 'New Conversation';
    }
    return 'New Conversation';
}

async function openConversation(conversationId) {
    try {
        // Update active conversation in UI
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-id="${conversationId}"]`).classList.add('active');

        // Load conversation details
        const response = await window.apiCall(`/agents/conversations/${conversationId}`);
        currentConversationId = conversationId;
        
        renderConversation(response);
        showChatInterface();
        
    } catch (error) {
        console.error('Failed to load conversation:', error);
        window.showToast('Failed to load conversation', 'error');
    }
}

function renderConversation(conversation) {
    const messagesContainer = document.getElementById('chat-messages');
    const chatTitle = document.getElementById('chat-title');
    const chatDocumentInfo = document.getElementById('chat-document-info');
    const chatDocumentName = document.getElementById('chat-document-name');
    
    // Update header
    chatTitle.textContent = getConversationTitle(conversation);
    
    if (conversation.document_name) {
        chatDocumentName.textContent = conversation.document_name;
        chatDocumentInfo.classList.remove('hidden');
    } else {
        chatDocumentInfo.classList.add('hidden');
    }
    
    // Clear and render messages
    if (messagesContainer) messagesContainer.innerHTML = '';
    
    if (!conversation.messages || conversation.messages.length === 0) {
        messagesContainer.innerHTML = `
            <div style="text-align: center; color: var(--text-secondary); padding: 3rem;">
                <p>No messages in this conversation yet</p>
            </div>
        `;
        return;
    }
    
    conversation.messages.forEach(message => {
        const messageHtml = `
            <div class="message ${message.role}">
                <div class="message-avatar">
                    <i class="fas fa-${message.role === 'user' ? 'user' : 'robot'}"></i>
                </div>
                <div class="message-content">
                    <div>${message.content}</div>
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                </div>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
    });
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showChatInterface() {
    const welcomeMessage = document.getElementById('welcome-message');
    const chatInputArea = document.getElementById('chat-input-area');
    const chatActions = document.getElementById('chat-actions');
    
    if (welcomeMessage) welcomeMessage.style.display = 'none';
    if (chatInputArea) chatInputArea.classList.remove('hidden');
    if (chatActions) chatActions.classList.remove('hidden');
}

async function startNewChat() {
    try {
        const response = await window.apiCall('/agents/conversations', {
            method: 'POST',
            body: JSON.stringify({})
        });
        
        currentConversationId = response.conversation.id;
        conversations.unshift(response.conversation);
        renderConversationList();
        openConversation(currentConversationId);
        
    } catch (error) {
        console.error('Failed to create new chat:', error);
        window.showToast('Failed to create new chat', 'error');
    }
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    const documentSelect = document.getElementById('document-select');
    const documentId = documentSelect.value || null;
    
    if (!message) return;
    
    // Clear input
    input.value = '';
    
    // Add user message to UI immediately
    addMessageToUI('user', message);
    
    try {
        const response = await askQuestion(message, documentId, currentConversationId);
        addMessageToUI('assistant', response.answer);
        
        // Update conversation in sidebar
        loadChatHistory();
        
    } catch (error) {
        addMessageToUI('assistant', 'Sorry, I encountered an error. Please try again.');
        console.error('Send message failed:', error);
    }
}

function addMessageToUI(role, content) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageHtml = `
        <div class="message ${role}">
            <div class="message-avatar">
                <i class="fas fa-${role === 'user' ? 'user' : 'robot'}"></i>
            </div>
            <div class="message-content">
                <div>${content}</div>
                <div class="message-time">Just now</div>
            </div>
        </div>
    `;
    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function updateDocumentSelector() {
    const select = document.getElementById('document-select');
    select.innerHTML = '<option value="">Ask about all documents</option>';
    
    userDocuments.forEach(doc => {
        if (doc.status === 'completed') {
            select.innerHTML += `<option value="${doc.id}">${doc.filename}</option>`;
        }
    });
}

async function deleteCurrentChat() {
    if (!currentConversationId) return;
    
    if (!confirm('Are you sure you want to delete this conversation?')) return;
    
    try {
        await window.apiCall(`/agents/conversations/${currentConversationId}`, {
            method: 'DELETE'
        });
        
        conversations = conversations.filter(c => c.id !== currentConversationId);
        renderConversationList();
        
        // Clear chat interface
        const chatMessages = document.getElementById('chat-messages');
        const welcomeMessage = document.getElementById('welcome-message');
        if (chatMessages) chatMessages.innerHTML = '';
        if (welcomeMessage) welcomeMessage.style.display = 'block';
        document.getElementById('chat-input-area').classList.add('hidden');
        document.getElementById('chat-actions').classList.add('hidden');
        
        currentConversationId = null;
        window.showToast('Conversation deleted', 'success');
        
    } catch (error) {
        console.error('Failed to delete conversation:', error);
        window.showToast('Failed to delete conversation', 'error');
    }
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffHours < 1) return 'Just now';
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

// Update the askQuestion function to include conversation_id
async function askQuestion(question, documentId = null, conversationId = null) {
    try {
        window.showLoading('Finding answer...');
        
        const response = await window.apiCall('/agents/ask-question', {
            method: 'POST',
            body: JSON.stringify({
                question: question,
                document_id: documentId,
                conversation_id: conversationId
            })
        });
        
        return response;
        
    } catch (error) {
        window.showToast(`Failed to get answer: ${error.message}`, 'error');
        throw error;
    }
}
</script>
{% endblock %}